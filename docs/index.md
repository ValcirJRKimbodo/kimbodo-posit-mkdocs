# Kimbodo Posit GCP installation (internal runbook)

This tutorial demonstrates **how to install Posit Workbench, Posit Connect, and Posit Package Manager on a GKE cluster**, In addition to the official Posit Helm charts, we’ll also use the [kimbodo-posit-base-resources](https://artifacthub.io/packages/helm/kimbodo-posit-base-resources/kimbodo-posit-base-resources) Helm chart. This chart sets up essential infrastructure components such as the base Ingress, HPA, NFS, and database required by all three tools.

## **Architecture Overview**

This document outlines the architecture and operational components of the Posit ecosystem deployed on Google Kubernetes Engine (GKE) within the a VPC both installed by terraform. The system includes the main Posit tools: **Posit Workbench**, **Posit Connect**, and **Posit Package Manager**, along with supporting services such as PostgreSQL, NFS, NGINx, and TLS automation.

![Archtecture overview](./img/archtecture-kimbodo-posit.jpg)

#### 1. Core Infrastructure

- **Cloud Platform**: Google Cloud Platform (GCP)
- **Kubernetes Cluster**: Google Kubernetes Engine (GKE)
- **Virtual Private Cloud (VPC)**: isolating internal communication
- **Node Pools**:
  - **General purpose node pool**: Runs core components
  - **Dedicated node pool**: Runs interactive job workloads (Posit Workbench sessions)

---

#### 2. Posit Components

| Component         | Description |
|------------------|-------------|
| [**Posit Workbench**](https://docs.posit.co/ide/server-pro/) | Interactive development environment (e.g., RStudio, Jupyter) |
| [**Posit Connect**](https://docs.posit.co/connect/user/)   | Hosting and publishing platform for R/Python/Shiny/Quarto apps |
| [**Posit Package Manager (PM)**](https://packagemanager.posit.co/__docs__/admin/) | Internal package repository manager for R, Python, and system packages |

Each of these components is deployed as a Kubernetes **pod**.

---
#### 3. Ingress & Security

| Component | Role |
|----------|------|
| **NGINX Ingress Controller** | Entry point for HTTPS traffic into the cluster |
| **cert-manager** | Automates TLS certificate issuance and renewal |
| **HTTPS Resolver (e.g., Let’s Encrypt)** | Provides TLS certificates to `cert-manager` |
| **Google OAuth2** | Identity provider for user authentication into Posit apps |

- TLS secrets generated by `cert-manager` are used by NGINX to enable secure HTTPS communication.
- Authentication is handled using Google’s OAuth2, allowing SSO integration.

---

#### 4. Workload Management

- Posit Workbench sessions spawn **job pods** in a separate node pool to isolate resource consumption.
- These workloads are short-lived, tied to user sessions, and automatically cleaned up afterward.

---

#### 5. Benefits of This Architecture

- **Scalability**: Independent node pools scale based on workload type (apps vs. sessions)
- **Security**: TLS encryption, OAuth2 authentication, and network isolation via VPC
- **Modularity**: Each service is loosely coupled and easily manageable
- **Automation**: DNS, certificates, and updates are handled automatically
- **Resilience**: Kubernetes-native deployment ensures high availability and failover

---

## **GCP Project Setup for Terraform Infrastructure Management**

This guide outlines the required steps to prepare a new Google Cloud Platform (GCP) project for managing infrastructure using **Terraform**. It covers:

- Creating a GCS bucket to store Terraform state
- Creating and configuring a Service Account
- Assigning the necessary IAM roles
- Enabling required APIs

---

### 1. Create a GCP Project

If not already done, create a new GCP project:

```bash
gcloud projects create [PROJECT_ID] --name="[PROJECT_NAME]"
gcloud config set project [PROJECT_ID]
```

---

### 2. Create a GCS Bucket for Terraform State

```bash
gsutil mb -p [PROJECT_ID] -c STANDARD -l [REGION] gs://[UNIQUE_BUCKET_NAME]/
gsutil versioning set on gs://[UNIQUE_BUCKET_NAME]
```

- The bucket name must be globally unique.
- Versioning is recommended for Terraform state recovery.

---

### 3. Create the Terraform Service Account

```bash
gcloud iam service-accounts create terraform --display-name "Terraform admin SA"
```

Then create and download the credentials file:

```bash
gcloud iam service-accounts keys create terraform-sa.json \
  --iam-account terraform@[PROJECT_ID].iam.gserviceaccount.com
```

---

### 4. Assign Required IAM Roles

Grant the Service Account the following roles:

```bash
gcloud projects add-iam-policy-binding [PROJECT_ID] \
  --member="serviceAccount:terraform@[PROJECT_ID].iam.gserviceaccount.com" \
  --role="roles/owner"
```

> You can restrict the permissions more finely if needed:

- `roles/compute.admin`
- `roles/container.admin`
- `roles/resourcemanager.projectIamAdmin`
- `roles/iam.serviceAccountUser`
- `roles/servicenetworking.networksAdmin`
- `roles/compute.networkAdmin`
- `roles/compute.securityAdmin`
- `roles/compute.addressAdmin`
---

### 5. Enable Required APIs

Before using Terraform to manage resources, enable these APIs:

```bash
gcloud services enable \
  compute.googleapis.com \
  container.googleapis.com \
  iam.googleapis.com \
  cloudresourcemanager.googleapis.com \
  serviceusage.googleapis.com \
  dns.googleapis.com
```

You can run them in one command as shown above.

---

###  6. Authenticate Terraform with the Service Account

Export the credentials before running Terraform:

```bash
export GOOGLE_APPLICATION_CREDENTIALS="./terraform-sa.json"
```

Then you can run:

```bash
terraform init
terraform plan
terraform apply
```

---

### 7. Checklist

You can run the following commands to confirm the setup:

```bash
# 1. Verify the GCS bucket exists
gsutil ls -p $PROJECT_ID

# 2. Check if bucket versioning is enabled
gsutil versioning get gs://$BUCKET_NAME

# 3. List enabled APIs
gcloud services list --enabled --project $PROJECT_ID

# 4. Validate service account existence
gcloud iam service-accounts list --project $PROJECT_ID

# 5. Check IAM roles attached to the service account
gcloud projects get-iam-policy $PROJECT_ID \
  --flatten="bindings[].members" \
  --format='table(bindings.role)' \
  --filter="bindings.members:terraform@$PROJECT_ID.iam.gserviceaccount.com"

# 6. Test credentials file (optional: set GOOGLE_APPLICATION_CREDENTIALS to path)
export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/terraform-sa.json"
gcloud auth activate-service-account --key-file=$GOOGLE_APPLICATION_CREDENTIALS
```
---